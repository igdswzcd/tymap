<template>
	<view class="container">
		<!-- æœç´¢æ¡† -->
		<view class="search-section">
			<view class="search-box">
				<input 
					class="search-input"
					type="text"
					v-model="searchKeyword"
					placeholder="æœç´¢ä½æˆ·å§“åã€æ‰‹æœºå·ã€æ ‹/å•å…ƒ/æ¥¼å±‚/é—¨å·"
					@input="onSearchInput"
					@confirm="performSearch"
				/>
				<view class="search-icon" @tap="performSearch">ğŸ”</view>
			</view>
			
			<!-- æœç´¢ç±»å‹ç­›é€‰ -->
			<view class="filter-section">
				<view 
					:class="['filter-item', searchType === 'all' ? 'active' : '']"
					@tap="setSearchType('all')"
				>
					å…¨éƒ¨
				</view>
				<view 
					:class="['filter-item', searchType === 'name' ? 'active' : '']"
					@tap="setSearchType('name')"
				>
					å§“å
				</view>
				<view 
					:class="['filter-item', searchType === 'phone' ? 'active' : '']"
					@tap="setSearchType('phone')"
				>
					æ‰‹æœºå·
				</view>
				<view 
					:class="['filter-item', searchType === 'location' ? 'active' : '']"
					@tap="setSearchType('location')"
				>
					ä½ç½®
				</view>
			</view>
		</view>

		<!-- æœç´¢å†å² -->
		<view class="history-section" v-if="searchHistory.length > 0 && searchKeyword === ''">
			<view class="section-header">
				<text class="section-title">æœç´¢å†å²</text>
				<text class="clear-btn" @tap="clearHistory">æ¸…ç©º</text>
			</view>
			<view class="history-list">
				<view 
					class="history-item"
					v-for="item in searchHistory"
					:key="item"
					@tap="useHistory(item)"
				>
					{{item}}
				</view>
			</view>
		</view>

		<!-- æœç´¢ç»“æœ -->
		<view class="results-section" v-if="searchResults.length > 0">
			<view class="section-header">
				<text class="section-title">æœç´¢ç»“æœ ({{searchResults.length}})</text>
			</view>
			<view class="results-list">
				<view 
					class="result-item"
					v-for="resident in searchResults"
					:key="resident._id"
					@tap="goToResident(resident)"
				>
					<view class="result-header">
						<image class="avatar" :src="resident.avatar || '/static/default-avatar.png'" mode="aspectFill"></image>
						<view class="resident-info">
							<text class="resident-name">{{resident.nickname}}</text>
							<text class="resident-phone">{{resident.phone || 'æœªç™»è®°æ‰‹æœºå·'}}</text>
						</view>
						<text :class="['credit-level', 'level-' + resident.credit_level]">
							{{resident.credit_level}}çº§
						</text>
					</view>
					<view class="location-info">
						{{resident.building}}æ ‹ {{resident.unit}}å•å…ƒ {{resident.floor}}å±‚ {{resident.door}}å·
					</view>
					<view class="tags-section">
						<text class="tag" v-if="resident.is_super_admin">è¶…çº§ç®¡ç†å‘˜</text>
						<text class="tag" v-if="resident.is_unit_admin">å•å…ƒç®¡ç†å‘˜</text>
						<text class="tag" v-if="resident.is_family_owner">å®¶åº­æˆ·ä¸»</text>
						<text class="tag">{{getOwnerTypeText(resident.owner_type)}}</text>
					</view>
				</view>
			</view>
		</view>

		<!-- æ— ç»“æœæç¤º -->
		<view class="no-results" v-if="searchKeyword && searchResults.length === 0">
			<text class="no-results-icon">ğŸ”</text>
			<text class="no-results-text">æœªæ‰¾åˆ°ç›¸å…³ä½æˆ·ä¿¡æ¯</text>
			<text class="no-results-tip">è¯·å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢</text>
		</view>

		<!-- è¿”å›æŒ‰é’® -->
		<view class="action-section">
			<view class="action-button" @tap="goBack">
				<text class="action-text">è¿”å›</text>
			</view>
		</view>
	</view>
</template>

<script lang="ts">
import { defineComponent, ref, reactive, onMounted } from 'vue'
import { onLoad } from '@dcloudio/uni-app'
import { initializeMockData } from '@/utils/mockData'

interface Resident {
	_id: string
	nickname: string
	avatar?: string
	phone?: string
	credit_level: number
	building: number
	unit: number
	floor: number
	door: number
	is_super_admin: boolean
	is_unit_admin: boolean
	is_family_owner: boolean
	owner_type: string
}

export default defineComponent({
	name: 'SearchPage',
	setup() {
		const searchKeyword = ref('')
		const searchType = ref<'all' | 'name' | 'phone' | 'location'>('all')
		const searchResults = ref<Resident[]>([])
		const searchHistory = ref<string[]>([])
		const isLoading = ref(false)

		// æœç´¢è¾“å…¥é˜²æŠ–
		let searchTimer: any = null

		// åˆå§‹åŒ–æœç´¢å†å²
		const initSearchHistory = () => {
			try {
				const history = uni.getStorageSync('searchHistory')
				if (history) {
					searchHistory.value = JSON.parse(history)
				}
			} catch (error) {
				console.error('è¯»å–æœç´¢å†å²å¤±è´¥:', error)
			}
		}

		// ä¿å­˜æœç´¢å†å²
		const saveSearchHistory = (keyword: string) => {
			if (!keyword.trim()) return
			
			// ç§»é™¤é‡å¤é¡¹
			searchHistory.value = searchHistory.value.filter(item => item !== keyword)
			
			// æ·»åŠ åˆ°å¼€å¤´
			searchHistory.value.unshift(keyword)
			
			// é™åˆ¶æœ€å¤šä¿å­˜20æ¡
			if (searchHistory.value.length > 20) {
				searchHistory.value = searchHistory.value.slice(0, 20)
			}
			
			// ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
			try {
				uni.setStorageSync('searchHistory', JSON.stringify(searchHistory.value))
			} catch (error) {
				console.error('ä¿å­˜æœç´¢å†å²å¤±è´¥:', error)
			}
		}

		// æ¸…ç©ºæœç´¢å†å²
		const clearHistory = () => {
			uni.showModal({
				title: 'ç¡®è®¤æ¸…ç©º',
				content: 'ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœç´¢å†å²å—ï¼Ÿ',
				success: (res) => {
					if (res.confirm) {
						searchHistory.value = []
						try {
							uni.removeStorageSync('searchHistory')
							uni.showToast({ title: 'å·²æ¸…ç©º', icon: 'success' })
						} catch (error) {
							console.error('æ¸…ç©ºæœç´¢å†å²å¤±è´¥:', error)
						}
					}
				}
			})
		}

		// ä½¿ç”¨æœç´¢å†å²
		const useHistory = (keyword: string) => {
			searchKeyword.value = keyword
			performSearch()
		}

		// è®¾ç½®æœç´¢ç±»å‹
		const setSearchType = (type: 'all' | 'name' | 'phone' | 'location') => {
			searchType.value = type
			if (searchKeyword.value) {
				performSearch()
			}
		}

		// æœç´¢è¾“å…¥å¤„ç†
		const onSearchInput = () => {
			if (searchTimer) {
				clearTimeout(searchTimer)
			}
			
			searchTimer = setTimeout(() => {
				if (searchKeyword.value.length > 0) {
					performSearch()
				} else {
					searchResults.value = []
				}
			}, 500)
		}

		// æ‰§è¡Œæœç´¢
		const performSearch = async () => {
			const keyword = searchKeyword.value.trim()
			if (!keyword) {
				searchResults.value = []
				return
			}

			isLoading.value = true
			
			try {
				const db = uniCloud.databaseForJQL()
				let query = db.collection('residents')
				
				// æ ¹æ®æœç´¢ç±»å‹æ„å»ºæŸ¥è¯¢æ¡ä»¶
				if (searchType.value === 'all') {
					// å…¨å±€æœç´¢ï¼šå§“åã€æ‰‹æœºå·ã€ä½ç½®ä¿¡æ¯
					query = query.where({
						$or: [
							{ nickname: new RegExp(keyword, 'i') },
							{ phone: new RegExp(keyword, 'i') },
							{ building: parseInt(keyword) || 0 },
							{ unit: parseInt(keyword) || 0 },
							{ floor: parseInt(keyword) || 0 },
							{ door: parseInt(keyword) || 0 }
						]
					})
				} else if (searchType.value === 'name') {
					// æŒ‰å§“åæœç´¢
					query = query.where({
						nickname: new RegExp(keyword, 'i')
					})
				} else if (searchType.value === 'phone') {
					// æŒ‰æ‰‹æœºå·æœç´¢
					query = query.where({
						phone: new RegExp(keyword, 'i')
					})
				} else if (searchType.value === 'location') {
					// æŒ‰ä½ç½®æœç´¢
					const buildingMatch = keyword.match(/(\d+)æ ‹/)
					const unitMatch = keyword.match(/(\d+)å•å…ƒ/)
					const floorMatch = keyword.match(/(\d+)å±‚/)
					const doorMatch = keyword.match(/(\d+)å·/)
					
					const conditions = []
					
					if (buildingMatch) {
						conditions.push({ building: parseInt(buildingMatch[1]) })
					}
					if (unitMatch) {
						conditions.push({ unit: parseInt(unitMatch[1]) })
					}
					if (floorMatch) {
						conditions.push({ floor: parseInt(floorMatch[1]) })
					}
					if (doorMatch) {
						conditions.push({ door: parseInt(doorMatch[1]) })
					}
					
					// å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°æ ¼å¼ï¼Œå°è¯•ç›´æ¥æœç´¢æ•°å­—
					if (conditions.length === 0) {
						const num = parseInt(keyword)
						if (!isNaN(num)) {
							conditions.push(
								{ building: num },
								{ unit: num },
								{ floor: num },
								{ door: num }
							)
						}
					}
					
					if (conditions.length > 0) {
						query = query.where({
							$or: conditions
						})
					}
				}
				
				const res = await query.get()
				searchResults.value = res.data as Resident[]
				
				// ä¿å­˜æœç´¢å†å²
				saveSearchHistory(keyword)
				
			} catch (error) {
				console.error('æœç´¢å¤±è´¥:', error)
				uni.showToast({
					title: 'æœç´¢å¤±è´¥',
					icon: 'none'
				})
			} finally {
				isLoading.value = false
			}
		}

		// è·å–æˆ·ä¸»ç±»å‹æ–‡æœ¬
		const getOwnerTypeText = (type: string): string => {
			switch (type) {
				case 'owner': return 'ä¸šä¸»'
				case 'tenant': return 'ç§Ÿå®¢'
				case 'family': return 'å®¶äºº'
				default: return 'æœªçŸ¥'
			}
		}

		// è·³è½¬åˆ°ä½æˆ·è¯¦æƒ…
		const goToResident = (resident: Resident) => {
			uni.navigateTo({
				url: `/pages/resident/resident?id=${resident._id}&building=${resident.building}&unit=${resident.unit}&floor=${resident.floor}&door=${resident.door}`
			})
		}

		// è¿”å›
		const goBack = () => {
			uni.navigateBack()
		}

		// é¡µé¢åŠ è½½
		onLoad(async () => {
			await initializeMockData()
			initSearchHistory()
		})

		return {
			searchKeyword,
			searchType,
			searchResults,
			searchHistory,
			isLoading,
			setSearchType,
			onSearchInput,
			performSearch,
			useHistory,
			clearHistory,
			getOwnerTypeText,
			goToResident,
			goBack
		}
	}
})
</script>

<style>
.container {
	padding: 20rpx;
	background-color: #f5f5f5;
	min-height: 100vh;
}

.search-section {
	margin-bottom: 30rpx;
}

.search-box {
	background: white;
	border-radius: 25rpx;
	padding: 20rpx 30rpx;
	display: flex;
	align-items: center;
	box-shadow: 0 2rpx 10rpx rgba(0,0,0,0.1);
	margin-bottom: 20rpx;
}

.search-input {
	flex: 1;
	font-size: 28rpx;
	border: none;
	outline: none;
}

.search-icon {
	font-size: 32rpx;
	margin-left: 20rpx;
	padding: 10rpx;
}

.filter-section {
	display: flex;
	justify-content: space-between;
	align-items: center;
}

.filter-item {
	background: white;
	border-radius: 20rpx;
	padding: 15rpx 30rpx;
	font-size: 24rpx;
	color: #666;
	box-shadow: 0 2rpx 10rpx rgba(0,0,0,0.1);
}

.filter-item.active {
	background: #2196f3;
	color: white;
}

.history-section {
	margin-bottom: 30rpx;
}

.section-header {
	display: flex;
	justify-content: space-between;
	align-items: center;
	margin-bottom: 20rpx;
}

.section-title {
	font-size: 32rpx;
	font-weight: bold;
	color: #333;
}

.clear-btn {
	font-size: 24rpx;
	color: #999;
}

.history-list {
	display: flex;
	flex-wrap: wrap;
	gap: 15rpx;
}

.history-item {
	background: white;
	border-radius: 15rpx;
	padding: 10rpx 20rpx;
	font-size: 24rpx;
	color: #666;
	box-shadow: 0 2rpx 10rpx rgba(0,0,0,0.1);
}

.results-section {
	margin-bottom: 30rpx;
}

.results-list {
	display: flex;
	flex-direction: column;
	gap: 20rpx;
}

.result-item {
	background: white;
	border-radius: 15rpx;
	padding: 30rpx;
	box-shadow: 0 2rpx 10rpx rgba(0,0,0,0.1);
}

.result-header {
	display: flex;
	align-items: center;
	margin-bottom: 20rpx;
}

.avatar {
	width: 80rpx;
	height: 80rpx;
	border-radius: 40rpx;
	margin-right: 20rpx;
}

.resident-info {
	flex: 1;
}

.resident-name {
	display: block;
	font-size: 32rpx;
	font-weight: bold;
	color: #333;
	margin-bottom: 5rpx;
}

.resident-phone {
	display: block;
	font-size: 24rpx;
	color: #666;
}

.credit-level {
	font-size: 20rpx;
	padding: 5rpx 10rpx;
	border-radius: 10rpx;
	text-align: center;
	color: white;
}

.credit-level.level-0 {
	background: #f39c12;
}

.credit-level.level-1 {
	background: #27ae60;
}

.credit-level.level-2 {
	background: #0984e3;
}

.location-info {
	font-size: 24rpx;
	color: #666;
	margin-bottom: 15rpx;
}

.tags-section {
	display: flex;
	flex-wrap: wrap;
	gap: 10rpx;
}

.tag {
	background: #e3f2fd;
	color: #1976d2;
	font-size: 20rpx;
	padding: 5rpx 10rpx;
	border-radius: 10rpx;
}

.no-results {
	text-align: center;
	padding: 100rpx 0;
}

.no-results-icon {
	font-size: 100rpx;
	color: #ccc;
	display: block;
	margin-bottom: 20rpx;
}

.no-results-text {
	display: block;
	font-size: 32rpx;
	color: #999;
	margin-bottom: 10rpx;
}

.no-results-tip {
	font-size: 24rpx;
	color: #ccc;
}

.action-section {
	margin-top: 40rpx;
}

.action-button {
	background: #2196f3;
	border-radius: 25rpx;
	padding: 20rpx;
	text-align: center;
}

.action-text {
	color: white;
	font-size: 28rpx;
	font-weight: bold;
}
</style>